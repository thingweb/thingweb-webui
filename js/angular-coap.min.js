angular.module("coap",[]).provider("CoAP",[function(){var t="http://localhost:8080"
this.setProxy=function(e){t=e},this.$get=["$window","$log","$q",function(e,s,o){function a(t){this.method="GET",this.uri=null,this.async=!0,this.onreadystatechange=function(){},this.readyState=0,this.payload="",this.onload=function(){},this.onerror=function(){}}if(e.coap_proxy)t!==e.coap_proxy&&(s.warn("coap proxy mismatch, overriding with configured"),e.coap_proxy=t)
else{e.coap_proxy=t
var n={64:{status:200,statusText:"OK"},65:{status:201,statusText:"Created"},66:{status:202,statusText:"Deleted"},67:{status:203,statusText:"Valid"},68:{status:204,statusText:"Changed"},69:{status:205,statusText:"Content"},128:{status:400,statusText:"Bad Request"},129:{status:401,statusText:"Unauthorized"},130:{status:402,statusText:"Bad Option"},131:{status:403,statusText:"Forbidden"},132:{status:404,statusText:"Not Found"},133:{status:405,statusText:"Method Not Allowed"},141:{status:413,statusText:"Request Entity Too Large"},143:{status:415,statusText:"Unsupported Content-Format"},160:{status:500,statusText:"Internal Server Error"},161:{status:501,statusText:"Not Implemented"},162:{status:502,statusText:"Bad Gateway"},163:{status:503,statusText:"Service Unavailable"},164:{status:504,statusText:"Gateway Timeout"},165:{status:505,statusText:"Proxying Not Supported"}}
a.prototype.open=function(t,e,s){this.method=t,this.uri=e,this.async=s},a.prototype.setRequestHeader=function(){},a.prototype.abort=function(){},a.prototype.getAllResponseHeaders=function(){},a.prototype.send=function(t){function e(){var t=JSON.parse(o.responseText)
if("error"in t)s.error=t.error
else{s.error=null
var e=n[t.code]||{status:500,statusText:"Unkown Status "+t.code}
s.status=e.status,s.statusText=e.statusText,s.code=t.code,s.responseText=t.payload}}this.payload=t
var s=this,o=new XMLHttpRequest
o.open("POST",window.coap_proxy+"/request",this.async),o.setRequestHeader("Content-Type","application/json")
var a=JSON.stringify({method:this.method,url:this.uri,payload:this.payload})
o.onreadystatechange=function(){s.readyState=o.readyState,s.onreadystatechange()},o.onload=function(){e(),s.error?s.onerror():s.onload()},o.onerror=function(){s.onerror()},o.send(a),this.async||e()}}var r={}
return r.doCoapReq=function(t,e,s){var n=o.defer(),r=new a
return r.open(t,e,!0),r.onload=function(){n.resolve(r.responseText)},r.onerror=function(){n.reject(r.error)},r.send(s),n.promise},r.get=function(t){return r.doCoapReq("GET",t)},r.put=function(t,e){return r.doCoapReq("PUT",t,e)},r.post=function(t,e){return r.doCoapReq("POST",t,e)},r["delete"]=function(t){return r.doCoapReq("DELETE",t)},r}]}])
